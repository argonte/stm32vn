#summary One-sentence summary of this page.

= GIỚI THIỆU =

  [https://stm32vn.googlecode.com/svn/trunk/Image/EASY_STM32_REVB.JPG]

  EASY_STM32 bao gồm module STlinkV2 tích hợp trên board, với 1 cổng USB device, có thể dùng để cấp nguồn cho board đồng thời gửi message debug lên máy tính. Có nghĩa ta không cần phải dùng kết nối UART cho hàm printf. Tính năng này được thực hiện bởi module ITM trên core ARM cortex-M.

  ITM (Instrumentation Trace Macrocell Unit) là gì ? ITM là ứng dụng cho phép gửi các trace packages debug hệ thống thông qua các thanh gi (ITM stimulus registers), các package này được debugger thu thập lại và gửi lên máy tính. Ví dụ tool Keil sử dụng Serial Wire Viewer (SWV) để hiển thị thông tin ra màn hình. Chương trình trên vi xử lý có thể xuất message thông qua hàm printf, lớp dưới của printf sẽ gọi đến các hàm xuất nhập chuẩn fputc(). Chúng ta thường sửa lại những hàm này để có thể hiển thị ra hyper terminal, hoặc LCD 16x2...Thao tác này được gọi là Retarget. Đối với ITM hoàn toàn có thể làm tương tự, các thông tin debug sẽ được hiển thị trên màn hình SWV trong Keil IDE.

  Phần sau đây hướng dẫn cách retarget cho ITM, test thử trên board EASY_STM32. 

= RETARGET =

  Các thanh ghi ITM stimulus được mô tả trong các tài liệu core ARM cortex-M, việc truy xuất các thanh ghi này được khai báo bởi các macro như sau:

  {{{
     #define ITM_Port8(n)    (*((volatile unsigned char *)(0xE0000000+4*n)))
     #define ITM_Port16(n)   (*((volatile unsigned short*)(0xE0000000+4*n)))
     #define ITM_Port32(n)   (*((volatile unsigned long *)(0xE0000000+4*n)))

     #define DEMCR           (*((volatile unsigned long *)(0xE000EDFC)))
     #define TRCENA          0x01000000
  }}}

= DEBUGGER SETTING =

  Trước khi sử dụng SWV, ta cần enable trace cho STlinkV2, thực hiện bằng cách chọn mục cấu hình debugger --> setting --> enable trace.  

  Kế đến ta tick select vào ITM Port 0 theo hình sau :
  

[http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer_port0_0.png]

= SỬ DỤNG SERIAL WIRE VIER =

  Ở menu, chọn "View" --> "Serial Windows" --> "Debug (printf) Viewer"   


 Select View - Serial Windows - Debug (printf) Viewer to launch the window.


 The Debug (printf) Viewer window displays data streams that are transmitted sequentially through the ITM Stimulus Port 0. Enable ITM Stimulus Port 0.

[http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer_select.png]

[http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer.png]

To use the viewer for trace output:

  Add ITM Stimulus Port register definitions to the source code.

  {{{
     #define ITM_Port8(n)    (*((volatile unsigned char *)(0xE0000000+4*n)))
     #define ITM_Port16(n)   (*((volatile unsigned short*)(0xE0000000+4*n)))
     #define ITM_Port32(n)   (*((volatile unsigned long *)(0xE0000000+4*n)))

     #define DEMCR           (*((volatile unsigned long *)(0xE000EDFC)))
     #define TRCENA          0x01000000
  }}}

  Định nghĩa lại hàm fputc() để thực hiện retarget cho hàm printf()

  {{{
     struct __FILE { int handle; /* Add whatever needed */ };
     FILE __stdout;
     FILE __stdin;

     int fputc(int ch, FILE *f) {
       if (DEMCR & TRCENA) {
         while (ITM_Port32(0) == 0);
         ITM_Port8(0) = ch;
       }
       return(ch);
     }
  }}}



 Add a fputc function which writes to the ITM Stimulus Port 0 register to the source code, which allows using printf for debug output.

  {{{
     struct __FILE { int handle; /* Add whatever needed */ };
     FILE __stdout;
     FILE __stdin;

     int fputc(int ch, FILE *f) {
       if (DEMCR & TRCENA) {
         while (ITM_Port32(0) == 0);
         ITM_Port8(0) = ch;
       }
       return(ch);
     }
  }}}

 Add the debug trace messages.

  {{{
     printf("AD value = 0x%04X\r\n", AD_value);
  }}}

 Set ITM Stimulus Port Port 0 bit to allow Trace to capture the ITM Port 0 information. Clear the Port 7..0 privilege bit to allow access to the Port 0 bit from User mode.

 [http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer_port0_0.png]

 Select View - Serial Windows - Debug (printf) Viewer to launch the window.

 [http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer_select.png]

 == Note ==

 Only data transmitted over ITM Stimulus port 0 is displayed in the Debug (printf) Viewer window. Other ITM Ports can be monitored with the Trace Records Window.

-------------------------------------------------------
== Reference link ==

[http://www.keil.com/support/man/docs/ulink2/ulink2_trace_itm_viewer.htm]
 